\section{Control Model}
\label{sec:controller:model}
    In Chapter~\ref{cha:observer}, a physical model of the system
    was derived. To incorporate the information from the physical model
    into the governing control law, the model needs to be fitted into Eq.
    \eqref{eq:controller:affinelq} by providing the Jacobi matrices with
    regards to $x$ and $u$, while also removing states which will not be
    used in the controller.

    The Jacobians of the system are acquired numerically by using
    central difference, as in Eq.~\eqref{eq:controller:centraldifference}.
    \begin{equation}
    \label{eq:controller:centraldifference}
        f'(x) \approx \frac{f(x+h) - f(x-h)}{2h}
    \end{equation}

    While all states are of importance to the dynamics of the quadrotor,
    only a subset of the states in $x$ is used for control.
    New matrices thus need to be formed, containing the relevant states.
    \paragraph{Notation}
    \begin{description}
        \item[] $\bar{x}$ denotes the rows in $x$ that are used for control.
        \item[] $\bar{x}^{\dagger}$ is used to denote the rows in $x$ that are \textit{not} used for control.
        \item[] $\bar{A} = [ \bar{A}^{\square} \bar{A}^{\dagger}]$
        defines the separation of the square part ($\square$) of $\bar{A}$ with columns
        associated with the controller states, from the other columns ($\dagger$).
    \end{description}

    The new matrices should contain only the rows that are to be used
    for control. Extracting those rows from Eq.~\eqref{eq:controller:gainscheduling:xdot}
    yields Eq.~\eqref{eq:controller:model:derivation}.
    \begin{equation}
        \label{eq:controller:model:derivation}
        \begin{array}{rl}
             \dot{\bar{x}} = \bar{f}(x,u) \approx & \bar{f}(x_{0},u_{0}) + \bar{A}(x - x_{0}) + \bar{B}\Delta u \\
             = & \bar{f}(x_{0},u_{0}) - \bar{A}^{\square}\bar{x}_{0} - \bar{A}^{\dagger}\bar{x}^{\dagger}_{0} + \bar{A}^{\square}\bar{x} + \bar{A}^{\dagger}\bar{x}^{\dagger} + \bar{B}\Delta u \\
             = & \bar{f}(x_{0},u_{0}) - \bar{A}^{\square}\bar{x}_{0} + \bar{A}^{\square}\bar{x} + \bar{B}\Delta u
        \end{array}
    \end{equation}
    In the last equality of Eq.~\eqref{eq:controller:model:derivation}, it
    is assumed that the states not described in the controller are invariant
    of control and time, giving $\bar{x}^{\dagger}_{0} = \bar{x}^{\dagger}$.
    The results of Eq.~\eqref{eq:controller:model:derivation} can be
    directly fitted into Eq.~\eqref{eq:controller:affinelq} to form
    the new matrices for the controller.
    The derivation of \eqref{eq:controller:model:derivation} is
    completely analogous in the discrete-time case.

    The following states, from Chapter~\ref{cha:observer}, are used in the control model:
    \begin{itemize}
        \item Velocities,
        \item Angular rates,
        \item Propeller velocities,
        \item Roll angle,
        \item Pitch angle.
    \end{itemize}
