\section{Motion Model}
\label{sec:observer:motionmodel}
    As the system studied in the filtering problem progresses through time,
    the state estimate can be significantly improved if a prediction
    is made on what measurements can be expected, and evaluating the plausibility
    of each measurement after how well they correspond to the prediction.
    With assumed Gaussian white noise distributions, this evaluation
    can be done in the probabilistic Kalman framework as presented in
    Sections~\ref{sec:observer:filtering}-\ref{sec:observer:ukf}, where the
    probability estimate of the sensors' measurements are based on the motion
    model's prediction. In this section, a motion model is derived and evaluated.
    The model is presented in its continuous form, since the discretization
    is made numerically on-line.

    \subsection{Coordinate Frames}
        In the model of the quadrotor, there are several frames of reference.
        \begin{description}
            \item[North-East-Down (NED):]
            The NED-frame is fixed at the center of gravity of the quadrotor.
            The NED system's $\hat{z}$-axis is aligned with the gravitational axis and
            the $\hat{x}$-axis along the northern axis.
            The $\hat{y}$-axis is chosen to point east to form a right-hand system.

            \item[North-East-Down Earth Fixed (NEDEF):] This frame is fixed at
            a given origin in the earth (such as the take-off point) and is
            considered an inertial frame, but is in all
            other aspects equivalent to the NED frame.
            All states are expressed in this frame of reference unless explicitly stated otherwise.
            This frame is often referred to as the ``world'' coordinate system,
            or ``$w$'' for short in equations in disambiguation from the NED system.

            \item[Body-fixed (BF):] The body-fixed coordinate system is fixed in the
            quadrotor with $\hat{x}$-axis in the forward direction and the $z$-axis in the downward
            direction - as depicted in Figure~\ref{fig:observer:motionmodel:quadrotorcoordframes}.

            \item[Propeller fixed:] Each of the propellers are associated
            with their own frame of reference, $P_{i}$, which tracks the
            virtual tilting of the thrust vector due to flapping,
            discussed in Section~\ref{ssec:observer:thrust}.

            \item[Camera frame:] This is the frame which describes the
            location of the camera.

            \item[PTAM frame:] This is the frame of reference used by the PTAM video SLAM library.
            This frame is initially unknown, and its recovery is discussed in Section~\ref{ssec:observer:sensormodels:camera}.

            \item[IMU frame:] This is the body-fixed frame in which the IMU measurements are said
            to be done. The origin is thus fixed close to the inertial sensors.
        \end{description}
        The coordinate frames are visualized in Figures~\ref{fig:observer:motionmodel:worldcoordframes}-\ref{fig:observer:motionmodel:quadrotorcoordframes}.
        \fig{0.8}{worldcoordframes}{The NEDEF, body-fixed and the PTAM coordinate frames are of global importance.}{fig:observer:motionmodel:worldcoordframes}
        \fig{0.8}{quadrotorcoordframes}{Locally, on the quadrotor, there are several coordinate frames used in the thesis. Here, the IMU frame coincides with the body-fixed frame.}{fig:observer:motionmodel:quadrotorcoordframes}

        The conversion between the reference frames are characterized by a
        transformation including translation and a three-dimensional rotation.
        Both the origin of the body-centered reference frames
        - the quadrotor's position - and the rotation of the body-fixed
        system are stored as system states.

        The centers of each of the propeller fixed coordinate systems
        are parametrized on the height $h$ and distance $d$ from the center of
        gravity as follows
        \begin{align}
            D_{0} &= (d, 0, h)^{BF} \\
            D_{1} &= (0, -d, h)^{BF} \\
            D_{2} &= (-d, 0, h)^{BF} \\
            D_{3} &= (0, d, h)^{BF}
        \end{align}

        In the following sections, vectors and points in e.g. the NED
        coordinate systems are denoted $x^{NED}$.
        Rotation described by unit quaternions are denoted $R(q)$ for
        the quaternion $q$, corresponding to the matrix rotation
        \citep{kuipers2002quaternions}\footnote{\citep{kuipers2002quaternions} uses a negated convention of signs compared to what is used here.}
        given by
%~ FIXME
%~ From http://www.euclideanspace.com/maths/geometry/rotations/conversions/quaternionToMatrix/index.htm
%~ and the Eigen src/Geometry/Quaternion.h. Note the equivalence given the unit length constraint on the rotation quaternion
%~ 1 - 2*qy2 - 2*qz2    2*qx*qy - 2*qz*qw   2*qx*qz + 2*qy*qw
%~ 2*qx*qy + 2*qz*qw    1 - 2*qx2 - 2*qz2   2*qy*qz - 2*qx*qw
%~ 2*qx*qz - 2*qy*qw    2*qy*qz + 2*qx*qw   1 - 2*qx2 - 2*qy2
        \begin{equation}
            \left(
            \begin{array}{cccc}
                q_{1}^{2} + q_{i}^{2} - q_{j}^{2} - q_{k}^{2}   & 2q_{i}q_{j}-2q_{1}q_{k}                       & 2q_{i}q_{k} + 2q_{1}q_{j} \\
                2q_{i}q_{j} + 2q_{1}q_{k}                       & q_{1}^{2} - q_{i}^{2} + q_{j}^{2} - q_{k}^{2} & 2q_{j}q_{k} - 2q_{1}q_{i} \\
                2q_{i}q_{k} - 2q_{1}q_{j}                       & 2q_{j}q_{k} + 2q_{1}q_{i}                     & q_{1}^{2} - q_{i}^{2} - q_{j}^{2} + q_{k}^{2}
            \end{array}
            \right) .
        \end{equation}

        Rotation quaternions describing the rotation \textit{to frame $a$ from frame $b$}
        is commonly denoted $q^{ab}$, whereas the \textit{b} may be dropped if the rotation is global, i.e. relative the NEDEF system.
        \textit{a} and \textit{b} are, where unambiguous, replaced by the first character of the
        name of the reference frame.
        Full transformations between coordinate systems - including rotation, translation and scaling -
        are similarly denoted $\mathcal{J}^{ab}$.

        The equations in this chapter is given in their time-continuous form
        to simplify the description of the forces.
        The equations are discretized in the implementation using numerical Euler integration (Eq. \eqref{eq:observer:euler})
        or Runge-Kutta integration (Eq. \eqref{eq:observer:rungekutta}), using an integration step of $T$.
        \begin{equation}
        \label{eq:observer:euler}
            X_{t+1} = X_{t} + T \cdot f(X,t)
        \end{equation}
        \begin{subequations}
        \label{eq:observer:rungekutta}
            \begin{align}
                X_{t+1} &= X_{t} + \tfrac{1}{6} \left(k_1 + 2k_2 + 2k_3 + k_4 \right) \\
                k_1 &= Tf(X, t) \\
                k_2 &= Tf(X_{t} + \tfrac{1}{2} k_1, t + \tfrac{1}{2}T) \\
                k_3 &= Tf(X_{t} + \tfrac{1}{2} k_2, t + \tfrac{1}{2}T) \\
                k_4 &= Tf(X_{t} + k_3, t + T)
            \end{align}
        \end{subequations}

    \subsection{Kinematics}
        The motions of the quadrotor are described by the following relations \citep{Pounds_modellingand}: % more citations needed?
        \begin{subequations}
            \label{eq:observer:kinematicsc}
            \begin{equation}
                \label{eq:observer:position}
                \dot{\xi} = V
            \end{equation}
            \begin{equation}
                \label{eq:observer:quaternionsc}
                \left(\begin{array}{c}
                    \dot{q}^{wb}_{0} \\
                    \dot{q}^{wb}_{i} \\
                    \dot{q}^{wb}_{j} \\
                    \dot{q}^{wb}_{k}
                \end{array}\right) = -\frac{1}{2}\left(\begin{array}{cccc}
                0 & -\omega_{x} & -\omega_{y} & -\omega_{z} \\
                \omega_{x} & 0 & -\omega_{z} & \omega_{y} \\
                \omega_{y} & \omega_{z} & 0 & -\omega_{x} \\
                \omega_{z} & -\omega_{y} & \omega_{x} & 0
                \end{array}\right)\left(\begin{array}{c}
                q^{wb}_{0} \\
                q^{wb}_{i} \\
                q^{wb}_{j} \\
                q^{wb}_{k}
                \end{array}\right)
            \end{equation}
        \end{subequations}

        In practice, a normalization step also has to be added to account for
        the unit length constraint on rotation quaternions.


    \subsection{Dynamics}
        The motions of the quadrotor can be fully explained by the
        forces and moments acting on the vehicle. Using the rigid-body assumption,
        Euler's extension of Newton's laws of motion applied to the
        quadrotor's center of gravity, $\mathcal{G}$, yields Eqs.~\ref{eq:motionmodel:newton}.
        These equations describe the acceleration and angular acceleration of the vehicle
        as related to the forces acting on the vehicle.
        \begin{subequations}
        \label{eq:motionmodel:newton}
            \begin{align}
                \dot{V} &= a^{w}_{\mathcal{G}} = R(q^{wb})\frac{1}{m}\sum F \\
                \dot{\Omega} &= R(q^{wb})I_{\mathcal{G}}^{-1}\sum M_{\mathcal{G}}
            \end{align}
        \end{subequations}

        The main forces acting upon the quadrotor are the effects of three different components
        \begin{itemize}
            \item $\sum_{i=1}^{4}F_{ri}$ - Rotor thrust,
            \item $F_{g}$ - Gravity,
            \item $F_{\text{wind}}$ - Wind.
        \end{itemize}

        Of these, the gravity is trivially described with the
        gravitational acceleration and the total mass of the quadrotor as
        \begin{equation}
            F_{g} = mg\cdot \hat{z}^{NED}
        \end{equation}

        The following sections will describe the rotor thrust and wind forces respectively.
        Additionally, other minor forces and moments are discussed in
        Section~\ref{ssec:observer:additionalforces}.

        \input{\currentchapter/thrust}
        \input{\currentchapter/wind}
        \input{\currentchapter/additionalforces}
